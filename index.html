<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">

    <title>How to Build a Bare Metal Switch (BMS) for SDN Labs by ajthompson0659</title>
  </head>

  <body>

    <header>
      <div class="container">
        <h1>How to Build a Bare Metal Switch (BMS) for SDN Labs</h1>
        <h2></h2>

        <section id="downloads">
          <a href="https://github.com/ajthompson0659" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <p>The hardware components that make up the BMS are as follows:</p>

<ul>
<li>Magma 13-Slot PCI Expansion Chassis w/ 4 Sun QFE NICs</li>
<li>Dell Opti-plex GX270 w/ Magma PCI Host Adaptor</li>
</ul>

<p>The Magma expansion chassis allows for the addition of upto 13 quad-port NICs to the Dell Opti-plex GX260 (or any host PC).  Adding extra ports to a PC in itself does not make this a BMS, if that was the case, any PC with two or more Ethernet ports could be called a BMS.  What makes this a BMS is the software.  To make this setup into a real bare-metal switch, I installed Open vSwitch on the host PC. Currently I have two BMS utilizing the above hardware configuration, except my current setup has 12 Sun QFE NICs in each BMS for a total of 48 FastEthernet ports per BMS.</p>

<p>The configuration for my BMS is below.</p>

<ul>
<li>Platform: Dell Opti-plex GX270</li>
<li>Processor(s): (1)x Pentium 4</li>
<li>OS: Ubuntu Server 14.04 LTS 32-bit</li>
<li>RAM: 256MB</li>
<li>Peripheral: MAGMA 13-Slot PCI Expansion Chassis w/ 12 Sun QFE NICs</li>
</ul>

<p><strong>IMPORTANT:</strong>
<strong>FOR THIS CONFIGURATION TO FUNCTION PROPERLY, RAM CANNOT EXCEED 256</strong>
<strong>MB.  OVER 256MB WILL CAUSE BASE ADDRESS REGISTER (BAR) CONFLICTS BETWEEN THE</strong>
<strong>SUN QFE NICS AND THE RAM, AND THE NICS WILL NOT FUNCTION.</strong></p>

<p><strong>If the MAGMA PCI Expansion unit is on during boot, the system will</strong>
<strong>freeze.  You must turn the unit on after system POST and prior to OS bootup.</strong>
<strong>Prevent the OS from booting before you turn the MAGMA unit on by setting the</strong>
<strong>GRUB_TIMEOUT value to -1 and commenting out the GRUB_HIDDEN variables</strong>
<strong>in the /etc/default/grub configuration file.  Update the configuration with</strong>
<strong>command: sudo update-grub</strong></p>

<h3>
<a id="change-the-grub_timeout-to--1-infinite" class="anchor" href="#change-the-grub_timeout-to--1-infinite" aria-hidden="true"><span class="octicon octicon-link"></span></a>Change the GRUB_TIMEOUT to -1 (infinite)</h3>

<p><em>nano /etc/default/grub</em></p>

<pre><code>GRUB_TIMEOUT=-1
</code></pre>

<p>Update the system configuration with the GRUB changes</p>

<pre><code>sudo update-grub
</code></pre>

<h3>
<a id="specify-the-name-for-all-network-devices-using-their-bus-ids" class="anchor" href="#specify-the-name-for-all-network-devices-using-their-bus-ids" aria-hidden="true"><span class="octicon octicon-link"></span></a>Specify the name for all network devices using their BUS IDs</h3>

<p><em>nano /etc/udev/rules.d/70-persistent-net.rules</em></p>

<pre><code>KERNELS==”0000:01:0c.0″, SUBSYSTEM==”net”, NAME=”eth0″
</code></pre>

<h3>
<a id="configure-ip-address-information-on-bootup" class="anchor" href="#configure-ip-address-information-on-bootup" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configure IP address information on bootup</h3>

<p><em>nano /etc/network/interfaces</em></p>

<pre><code>auto lo
iface lo inet loopback

#PRIMARY NETWORK
auto eth0
iface eth0 inet static
address 192.168.206.201
netmask 255.255.255.0
network 192.168.206.0
broadcast 192.168.206.255
gateway 192.168.206.254
dns-nameservers 192.168.206.254
</code></pre>

<h3>
<a id="tune-the-pc-boot-time-to-skip-waiting-for-network-configuration" class="anchor" href="#tune-the-pc-boot-time-to-skip-waiting-for-network-configuration" aria-hidden="true"><span class="octicon octicon-link"></span></a>Tune the PC boot-time to skip waiting for network configuration</h3>

<p><em>nano /etc/init/failsafe.conf</em></p>

<p>Change this…</p>

<pre><code>$PLYMOUTH message –text=”Waiting for network configuration…” || :
sleep 40
$PLYMOUTH message –text=”Waiting up to 60 more seconds for network configuration…” || :
sleep 59
$PLYMOUTH message –text=”Booting system without full network configuration…” || :
</code></pre>

<p>To this…</p>

<pre><code>$PLYMOUTH message –text=”Waiting for network configuration…” || :
sleep 1
$PLYMOUTH message –text=”Waiting up to 60 more seconds for network configuration…” || :
sleep 1
$PLYMOUTH message –text=”Booting system without full network configuration…” || :
</code></pre>

<h3>
<a id="enable-ipv4-forwarding-and-disable-ipv6" class="anchor" href="#enable-ipv4-forwarding-and-disable-ipv6" aria-hidden="true"><span class="octicon octicon-link"></span></a>Enable IPv4 forwarding and disable IPv6.</h3>

<p>__nano /etc/sysctl.conf</p>

<p>Uncomment the line</p>

<pre><code>net.ipv4.ip_forward=1
</code></pre>

<p>Add below lines to disable IPv6 configuration (optional)</p>

<pre><code>net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
net.ipv6.conf.lo.disable_ipv6 = 1
</code></pre>

<p>Install HTOP system resource monitoring</p>

<pre><code>apt-get install htop
</code></pre>

<p>Install Open vSwitch (OVS)</p>

<pre><code>apt-get install openvswitch-common openvswitch-controller openvswitch-dbg openvswitch-ipsec openvswitch-pki openvswitch-switch openvswitch-datapath-source openvswitch-test openvswitch-datapath-dkms
</code></pre>

<p>Verify OVS installation</p>

<pre><code>ovs-vsctl show
</code></pre>

<p>Install User-mode Linux Utilities (uml-utilities) for creation of persistant TAP interfaces used with OVS bridges and other applications</p>

<p>Install OpenVPN for the creation of layer 2 VPN tunnels used with OVS to connect real switch ports and other real/virtual nodes</p>

<pre><code>apt-get install uml-utilities openvpn
</code></pre>

<p>Restart the computer ensuring the MAGMA is off until the GRUB menu appears !!
Once the MAGMA is powered on, continue booting the OS.  This must be done
for every system restart.</p>

<h3>
<a id="enumerate-pci-ethernet-devices-to-get-bus-id-of-all-sw-ports" class="anchor" href="#enumerate-pci-ethernet-devices-to-get-bus-id-of-all-sw-ports" aria-hidden="true"><span class="octicon octicon-link"></span></a>Enumerate PCI ethernet devices to get BUS ID of all sw ports</h3>

<p><em>lspci | grep Ethernet</em></p>

<pre><code>04:00.1 Ethernet controller: Oracle/SUN Happy Meal 10/100 Ethernet [hme] (rev 01)
04:01.1 Ethernet controller: Oracle/SUN Happy Meal 10/100 Ethernet [hme] (rev 01)
04:02.1 Ethernet controller: Oracle/SUN Happy Meal 10/100 Ethernet [hme] (rev 01)
04:03.1 Ethernet controller: Oracle/SUN Happy Meal 10/100 Ethernet [hme] (rev 01)
05:00.1 Ethernet controller: Oracle/SUN Happy Meal 10/100 Ethernet [hme] (rev 01)
05:01.1 Ethernet controller: Oracle/SUN Happy Meal 10/100 Ethernet [hme] (rev 01)
05:02.1 Ethernet controller: Oracle/SUN Happy Meal 10/100 Ethernet [hme] (rev 01)
05:03.1 Ethernet controller: Oracle/SUN Happy Meal 10/100 Ethernet [hme] (rev 01)
and so on....
</code></pre>

<h3>
<a id="verify-system-awareness-of-network-devices" class="anchor" href="#verify-system-awareness-of-network-devices" aria-hidden="true"><span class="octicon octicon-link"></span></a>Verify system awareness of network devices</h3>

<p><em>find /sys -name net</em></p>

<pre><code>/sys/devices/pci0000:00/0000:00:1e.0/0000:01:0a.0/0000:02:04.0/0000:03:04.0/0000:04:00.1/net
/sys/devices/pci0000:00/0000:00:1e.0/0000:01:0a.0/0000:02:04.0/0000:03:04.0/0000:04:01.1/net
/sys/devices/pci0000:00/0000:00:1e.0/0000:01:0a.0/0000:02:04.0/0000:03:04.0/0000:04:02.1/net
/sys/devices/pci0000:00/0000:00:1e.0/0000:01:0a.0/0000:02:04.0/0000:03:04.0/0000:04:03.1/net
/sys/devices/pci0000:00/0000:00:1e.0/0000:01:0a.0/0000:02:04.0/0000:03:05.0/0000:05:00.1/net
/sys/devices/pci0000:00/0000:00:1e.0/0000:01:0a.0/0000:02:04.0/0000:03:05.0/0000:05:01.1/net
/sys/devices/pci0000:00/0000:00:1e.0/0000:01:0a.0/0000:02:04.0/0000:03:05.0/0000:05:02.1/net
/sys/devices/pci0000:00/0000:00:1e.0/0000:01:0a.0/0000:02:04.0/0000:03:05.0/0000:05:03.1/net
and so on....
</code></pre>

<p>Specify the name for all network devices using their BUS IDs</p>

<p><em>nano /etc/udev/rules.d/70-persistent-net.rules</em></p>

<pre><code>KERNELS==”0000:04:00.1″, SUBSYSTEM==”net”, NAME=”port-101″
KERNELS==”0000:04:01.1″, SUBSYSTEM==”net”, NAME=”port-102″
KERNELS==”0000:04:02.1″, SUBSYSTEM==”net”, NAME=”port-103″
KERNELS==”0000:04:03.1″, SUBSYSTEM==”net”, NAME=”port-104″
KERNELS==”0000:05:00.1″, SUBSYSTEM==”net”, NAME=”port-105″
KERNELS==”0000:05:01.1″, SUBSYSTEM==”net”, NAME=”port-106″
KERNELS==”0000:05:02.1″, SUBSYSTEM==”net”, NAME=”port-107″
KERNELS==”0000:05:03.1″, SUBSYSTEM==”net”, NAME=”port-108″
and so on....
</code></pre>

<h3>
<a id="shutdown-and-restart-system-for-changes-to-take-effect" class="anchor" href="#shutdown-and-restart-system-for-changes-to-take-effect" aria-hidden="true"><span class="octicon octicon-link"></span></a>Shutdown and restart system for changes to take effect</h3>

<p><em>shutdown -h now</em></p>

<h3>
<a id="install-ethtool-for-port-configuration" class="anchor" href="#install-ethtool-for-port-configuration" aria-hidden="true"><span class="octicon octicon-link"></span></a>Install Ethtool for port configuration</h3>

<p><em>apt-get install ethtool</em></p>

<p>Run below script on the CLI to update the /etc/network/interfaces file with all newly configured ports</p>

<pre><code>for i in $(ifconfig -a | grep port | awk ‘{ print  $1 }’); do printf “\nauto $i \niface $i inet manual \n\t pre-up /sbin/ethtool -s \$IFACE speed 100 duplex full \n\t up ifconfig \$IFACE 0.0.0.0 up \n\t up ip link net \$IFACE promisc on \n” &gt;&gt; /etc/network/interfaces;done
</code></pre>

<p>Shutdown and restart system for changes to take effect</p>

<p><em>shutdown -h now</em></p>

<h3>
<a id="configuration-complete" class="anchor" href="#configuration-complete" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configuration Complete</h3>

<p>As you can see by the warnings I’ve posted in the above configuration, using an old low-end PC as a BMS may require a few unique tweaks. It took me alot of time researching and applying fixes to overcome the BAR issue noted above. I did create a BMS using a Dell PowerEdge 1850 1u server with 4GB RAM and the only real issue I ran into was that I had to put the Magma PCI Host adaptor into the 1st PCI slot on the server. If I put it in the 2nd PCI slot by mistake, it would cause significant errors. Most of the issues seam to stem from the fact that these old PCs and servers were never intended to host so many PCI bridges (which are found in all the QFE NICs).</p>

<p>Performance-wise, the BMS I’ve built can handle alot of lab traffice considering it runs with 256MB RAM and a Pentium4 processor. I’ve linked the BMS to Floodlight as the OFController and everything worked perfectly.</p>

<p>I hope you found this information helpful, now go build your own BMS and let me know how it turns out!</p>
      </section>
    </div>

    
  </body>
</html>